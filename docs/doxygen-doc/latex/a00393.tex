

It can be desirable to include hwloc in a larger software package (be sure to check out the L\+I\+C\+E\+N\+SE file) so that users don\textquotesingle{}t have to separately download and install it before installing your software. This can be advantageous to ensure that your software uses a known-\/tested/good version of hwloc, or for use on systems that do not have hwloc pre-\/installed.

When used in \char`\"{}embedded\char`\"{} mode, hwloc will\+:


\begin{DoxyItemize}
\item not install any header files
\item not build any documentation files
\item not build or install any executables or tests
\item not build {\ttfamily libhwloc.$\ast$} -- instead, it will build {\ttfamily libhwloc\+\_\+embedded.$\ast$}
\end{DoxyItemize}

There are two ways to put hwloc into \char`\"{}embedded\char`\"{} mode. The first is directly from the configure command line\+:

\begin{DoxyVerb}shell$ ./configure --enable-embedded-mode ...
\end{DoxyVerb}


The second requires that your software project uses the G\+NU Autoconf / Automake / Libtool tool chain to build your software. If you do this, you can directly integrate hwloc\textquotesingle{}s m4 configure macro into your configure script. You can then invoke hwloc\textquotesingle{}s configuration tests and build setup by calling a m4 macro (see below).

Although hwloc dynamic shared object plugins may be used in embedded mode, the embedder project will have to manually setup dlopen or libltdl in its build system so that hwloc can load its plugins at run time. Also, embedders should be aware of complications that can arise due to public and private linker namespaces (e.\+g., if the embedder project is loaded into a private namespace and then hwloc tries to dynamically load its plugins, such loading may fail since the hwloc plugins can\textquotesingle{}t find the hwloc symbols they need). The embedder project is {\bfseries strongly} advised not to use hwloc\textquotesingle{}s dynamically loading plugins / dlopen / libltdl capability.

 \hypertarget{a00393_embedding_m4}{}\section{Using hwloc\textquotesingle{}s M4 Embedding Capabilities}\label{a00393_embedding_m4}
Every project is different, and there are many different ways of integrating hwloc into yours. What follows is {\itshape one} example of how to do it.

If your project uses recent versions Autoconf, Automake, and Libtool to build, you can use hwloc\textquotesingle{}s embedded m4 capabilities. We have tested the embedded m4 with projects that use Autoconf 2.\+65, Automake 1.\+11.\+1, and Libtool 2.\+2.\+6b. Slightly earlier versions of may also work but are untested. Autoconf versions prior to 2.\+65 are almost certain to not work.

You can either copy all the config/hwloc$\ast$m4 files from the hwloc source tree to the directory where your project\textquotesingle{}s m4 files reside, or you can tell aclocal to find more m4 files in the embedded hwloc\textquotesingle{}s \char`\"{}config\char`\"{} subdirectory (e.\+g., add \char`\"{}-\/\+Ipath/to/embedded/hwloc/config\char`\"{} to your Makefile.\+am\textquotesingle{}s A\+C\+L\+O\+C\+A\+L\+\_\+\+A\+M\+F\+L\+A\+GS).

The following macros can then be used from your configure script (only H\+W\+L\+O\+C\+\_\+\+S\+E\+T\+U\+P\+\_\+\+C\+O\+RE {\itshape must} be invoked if using the m4 macros)\+:


\begin{DoxyItemize}
\item H\+W\+L\+O\+C\+\_\+\+S\+E\+T\+U\+P\+\_\+\+C\+O\+RE(config-\/dir-\/prefix, action-\/upon-\/success, action-\/upon-\/failure, print\+\_\+banner\+\_\+or\+\_\+not)\+: Invoke the hwloc configuration tests and setup the hwloc tree to build. The first argument is the prefix to use for A\+C\+\_\+\+O\+U\+T\+P\+UT files -- it\textquotesingle{}s where the hwloc tree is located relative to {\ttfamily \$top\+\_\+srcdir}. Hence, if your embedded hwloc is located in the source tree at contrib/hwloc, you should pass {\ttfamily \mbox{[}contrib/hwloc\mbox{]}} as the first argument. If H\+W\+L\+O\+C\+\_\+\+S\+E\+T\+U\+P\+\_\+\+C\+O\+RE and the rest of {\ttfamily configure} completes successfully, then \char`\"{}make\char`\"{} traversals of the hwloc tree with standard Automake targets (all, clean, install, etc.) should behave as expected. For example, it is safe to list the hwloc directory in the S\+U\+B\+D\+I\+RS of a higher-\/level Makefile.\+am. The last argument, if not empty, will cause the macro to display an announcement banner that it is starting the hwloc core configuration tests.

H\+W\+L\+O\+C\+\_\+\+S\+E\+T\+U\+P\+\_\+\+C\+O\+RE will set the following environment variables and A\+C\+\_\+\+S\+U\+B\+ST them\+: H\+W\+L\+O\+C\+\_\+\+E\+M\+B\+E\+D\+D\+E\+D\+\_\+\+C\+F\+L\+A\+GS, H\+W\+L\+O\+C\+\_\+\+E\+M\+B\+E\+D\+D\+E\+D\+\_\+\+C\+P\+P\+F\+L\+A\+GS, and H\+W\+L\+O\+C\+\_\+\+E\+M\+B\+E\+D\+D\+E\+D\+\_\+\+L\+I\+BS. These flags are filled with the values discovered in the hwloc-\/specific m4 tests, and can be used in your build process as relevant. The \+\_\+\+C\+F\+L\+A\+GS, \+\_\+\+C\+P\+P\+F\+L\+A\+GS, and \+\_\+\+L\+I\+BS variables are necessary to build libhwloc (or libhwloc\+\_\+embedded) itself.

H\+W\+L\+O\+C\+\_\+\+S\+E\+T\+U\+P\+\_\+\+C\+O\+RE also sets H\+W\+L\+O\+C\+\_\+\+E\+M\+B\+E\+D\+D\+E\+D\+\_\+\+L\+D\+A\+DD environment variable (and A\+C\+\_\+\+S\+U\+B\+S\+Ts it) to contain the location of the libhwloc\+\_\+embedded.\+la convenience Libtool archive. It can be used in your build process to link an application or other library against the embedded hwloc library.

{\bfseries N\+O\+TE\+: If the H\+W\+L\+O\+C\+\_\+\+S\+E\+T\+\_\+\+S\+Y\+M\+B\+O\+L\+\_\+\+P\+R\+E\+F\+IX macro is used, it must be invoked {\itshape before} H\+W\+L\+O\+C\+\_\+\+S\+E\+T\+U\+P\+\_\+\+C\+O\+RE.}
\item H\+W\+L\+O\+C\+\_\+\+B\+U\+I\+L\+D\+\_\+\+S\+T\+A\+N\+D\+A\+L\+O\+NE\+: H\+W\+L\+O\+C\+\_\+\+S\+E\+T\+U\+P\+\_\+\+C\+O\+RE defaults to building hwloc in an \char`\"{}embedded\char`\"{} mode (described above). If H\+W\+L\+O\+C\+\_\+\+B\+U\+I\+L\+D\+\_\+\+S\+T\+A\+N\+D\+A\+L\+O\+NE is invoked $\ast$before$\ast$ H\+W\+L\+O\+C\+\_\+\+S\+E\+T\+U\+P\+\_\+\+C\+O\+RE, the embedded definitions will not apply (e.\+g., libhwloc.\+la will be built, not libhwloc\+\_\+embedded.\+la).
\item H\+W\+L\+O\+C\+\_\+\+S\+E\+T\+\_\+\+S\+Y\+M\+B\+O\+L\+\_\+\+P\+R\+E\+F\+I\+X(foo\+\_\+)\+: Tells the hwloc to prefix all of hwloc\textquotesingle{}s types and public symbols with \char`\"{}foo\+\_\+\char`\"{}; meaning that function hwloc\+\_\+init() becomes foo\+\_\+hwloc\+\_\+init(). Enum values are prefixed with an upper-\/case translation if the prefix supplied; H\+W\+L\+O\+C\+\_\+\+O\+B\+J\+\_\+\+C\+O\+RE becomes F\+O\+O\+\_\+hwloc\+\_\+\+O\+B\+J\+\_\+\+C\+O\+RE. This is recommended behavior if you are including hwloc in middleware -- it is possible that your software will be combined with other software that links to another copy of hwloc. If both uses of hwloc utilize different symbol prefixes, there will be no type/symbol clashes, and everything will compile, link, and run successfully. If you both embed hwloc without changing the symbol prefix and also link against an external hwloc, you may get multiple symbol definitions when linking your final library or application.
\item H\+W\+L\+O\+C\+\_\+\+S\+E\+T\+U\+P\+\_\+\+D\+O\+CS, H\+W\+L\+O\+C\+\_\+\+S\+E\+T\+U\+P\+\_\+\+U\+T\+I\+LS, H\+W\+L\+O\+C\+\_\+\+S\+E\+T\+U\+P\+\_\+\+T\+E\+S\+TS\+: These three macros only apply when hwloc is built in \char`\"{}standalone\char`\"{} mode (i.\+e., they should N\+OT be invoked unless H\+W\+L\+O\+C\+\_\+\+B\+U\+I\+L\+D\+\_\+\+S\+T\+A\+N\+D\+A\+L\+O\+NE has already been invoked).
\item H\+W\+L\+O\+C\+\_\+\+D\+O\+\_\+\+A\+M\+\_\+\+C\+O\+N\+D\+I\+T\+I\+O\+N\+A\+LS\+: If you embed hwloc in a larger project and build it conditionally with Automake (e.\+g., if H\+W\+L\+O\+C\+\_\+\+S\+E\+T\+U\+P\+\_\+\+C\+O\+RE is invoked conditionally), you must unconditionally invoke H\+W\+L\+O\+C\+\_\+\+D\+O\+\_\+\+A\+M\+\_\+\+C\+O\+N\+D\+I\+T\+I\+O\+N\+A\+LS to avoid warnings from Automake (for the cases where hwloc is not selected to be built). This macro is necessary because hwloc uses some A\+M\+\_\+\+C\+O\+N\+D\+I\+T\+I\+O\+N\+A\+Ls to build itself, and A\+M\+\_\+\+C\+O\+N\+D\+I\+T\+I\+O\+N\+A\+Ls cannot be defined conditionally. Note that it is safe (but unnecessary) to call H\+W\+L\+O\+C\+\_\+\+D\+O\+\_\+\+A\+M\+\_\+\+C\+O\+N\+D\+I\+T\+I\+O\+N\+A\+LS even if H\+W\+L\+O\+C\+\_\+\+S\+E\+T\+U\+P\+\_\+\+C\+O\+RE is invoked unconditionally. If you are not using Automake to build hwloc, this macro is unnecessary (and will actually cause errors because it invoked A\+M\+\_\+$\ast$ macros that will be undefined).
\end{DoxyItemize}

{\bfseries N\+O\+TE\+:} When using the H\+W\+L\+O\+C\+\_\+\+S\+E\+T\+U\+P\+\_\+\+C\+O\+RE m4 macro, it may be necessary to explicitly invoke A\+C\+\_\+\+C\+A\+N\+O\+N\+I\+C\+A\+L\+\_\+\+T\+A\+R\+G\+ET (which requires config.\+sub and config.\+guess) and/or A\+C\+\_\+\+U\+S\+E\+\_\+\+S\+Y\+S\+T\+E\+M\+\_\+\+E\+X\+T\+E\+N\+S\+I\+O\+NS macros early in the configure script (e.\+g., after A\+C\+\_\+\+I\+N\+IT but before A\+M\+\_\+\+I\+N\+I\+T\+\_\+\+A\+U\+T\+O\+M\+A\+KE). See the Autoconf documentation for further information.

Also note that hwloc\textquotesingle{}s top-\/level configure.\+ac script uses exactly the macros described above to build hwloc in a standalone mode (by default). You may want to examine it for one example of how these macros are used.

 \hypertarget{a00393_embedding_example}{}\section{Example Embedding hwloc}\label{a00393_embedding_example}
Here\textquotesingle{}s an example of integrating with a larger project named sandbox that already uses Autoconf, Automake, and Libtool to build itself\+:

\begin{DoxyVerb}# First, cd into the sandbox project source tree
shell$ cd sandbox
shell$ cp -r /somewhere/else/hwloc-<version> my-embedded-hwloc
shell$ edit Makefile.am
  1. Add "-Imy-embedded-hwloc/config" to ACLOCAL_AMFLAGS
  2. Add "my-embedded-hwloc" to SUBDIRS
  3. Add "$(HWLOC_EMBEDDED_LDADD)" and "$(HWLOC_EMBEDDED_LIBS)" to 
     sandbox's executable's LDADD line.  The former is the name of the 
     Libtool convenience library that hwloc will generate.  The latter 
     is any dependent support libraries that may be needed by 
     $(HWLOC_EMBEDDED_LDADD).
  4. Add "$(HWLOC_EMBEDDED_CFLAGS)" to AM_CFLAGS
  5. Add "$(HWLOC_EMBEDDED_CPPFLAGS)" to AM_CPPFLAGS
shell$ edit configure.ac
  1. Add "HWLOC_SET_SYMBOL_PREFIX(sandbox_hwloc_)" line
  2. Add "HWLOC_SETUP_CORE([my-embedded-hwloc], [happy=yes], [happy=no])" line
  3. Add error checking for happy=no case
shell$ edit sandbox.c
  1. Add #include <hwloc.h>
  2. Add calls to sandbox_hwloc_init() and other hwloc API functions
\end{DoxyVerb}


Now you can bootstrap, configure, build, and run the sandbox as normal -- all calls to \char`\"{}sandbox\+\_\+hwloc\+\_\+$\ast$\char`\"{} will use the embedded hwloc rather than any system-\/provided copy of hwloc. 