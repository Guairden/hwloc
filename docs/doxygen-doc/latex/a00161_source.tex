\hypertarget{a00161_source}{}\section{rsmi.\+h}
\label{a00161_source}\index{rsmi.\+h@{rsmi.\+h}}

\begin{DoxyCode}
00001 \textcolor{comment}{/*}
00002 \textcolor{comment}{ * Copyright Â© 2012-2020 Inria.  All rights reserved.}
00003 \textcolor{comment}{ * Copyright (c) 2020, Advanced Micro Devices, Inc. All rights reserved.}
00004 \textcolor{comment}{ * Written by Advanced Micro Devices,}
00005 \textcolor{comment}{ * See COPYING in top-level directory.}
00006 \textcolor{comment}{ */}
00007 
00015 \textcolor{preprocessor}{#ifndef HWLOC\_RSMI\_H}
00016 \textcolor{preprocessor}{#define HWLOC\_RSMI\_H}
00017 
00018 \textcolor{preprocessor}{#include "hwloc.h"}
00019 \textcolor{preprocessor}{#include "hwloc/autogen/config.h"}
00020 \textcolor{preprocessor}{#include "hwloc/helper.h"}
00021 \textcolor{preprocessor}{#ifdef HWLOC\_LINUX\_SYS}
00022 \textcolor{preprocessor}{#include "hwloc/linux.h"}
00023 \textcolor{preprocessor}{#endif}
00024 
00025 \textcolor{preprocessor}{#include <rocm\_smi/rocm\_smi.h>}
00026 
00027 
00028 \textcolor{preprocessor}{#ifdef \_\_cplusplus}
00029 \textcolor{keyword}{extern} \textcolor{stringliteral}{"C"} \{
00030 \textcolor{preprocessor}{#endif}
00031 
00032 
00059 \textcolor{keyword}{static} \_\_hwloc\_inline \textcolor{keywordtype}{int}
\Hypertarget{a00161_source_l00060}\hyperlink{a00222_gaf939e697e3769c3524255318262b9c29}{00060} \hyperlink{a00222_gaf939e697e3769c3524255318262b9c29}{hwloc\_rsmi\_get\_device\_cpuset}(\hyperlink{a00186_ga9d1e76ee15a7dee158b786c30b6a6e38}{hwloc\_topology\_t} topology 
      \_\_hwloc\_attribute\_unused,
00061                              uint32\_t dv\_ind, \hyperlink{a00183_ga4bbf39b68b6f568fb92739e7c0ea7801}{hwloc\_cpuset\_t} \textcolor{keyword}{set})
00062 \{
00063 \textcolor{preprocessor}{#ifdef HWLOC\_LINUX\_SYS}
00064   \textcolor{comment}{/* If we're on Linux, use the sysfs mechanism to get the local cpus */}
00065 \textcolor{preprocessor}{#define HWLOC\_RSMI\_DEVICE\_SYSFS\_PATH\_MAX 128}
00066   \textcolor{keywordtype}{char} path[HWLOC\_RSMI\_DEVICE\_SYSFS\_PATH\_MAX];
00067   rsmi\_status\_t ret;
00068   uint64\_t bdfid = 0;
00069   \textcolor{keywordtype}{unsigned} domain, device, bus;
00070 
00071   \textcolor{keywordflow}{if} (!\hyperlink{a00193_ga68ffdcfd9175cdf40709801092f18017}{hwloc\_topology\_is\_thissystem}(topology)) \{
00072     errno = EINVAL;
00073     \textcolor{keywordflow}{return} -1;
00074   \}
00075 
00076   ret = rsmi\_dev\_pci\_id\_get(dv\_ind, &bdfid);
00077   \textcolor{keywordflow}{if} (RSMI\_STATUS\_SUCCESS != ret) \{
00078     errno = EINVAL;
00079     \textcolor{keywordflow}{return} -1;
00080   \}
00081   domain = (bdfid>>32) & 0xffffffff;
00082   bus = ((bdfid & 0xffff)>>8) & 0xff;
00083   device = ((bdfid & 0xff)>>3) & 0x1f;
00084 
00085   sprintf(path, \textcolor{stringliteral}{"/sys/bus/pci/devices/%04x:%02x:%02x.0/local\_cpus"}, domain, bus, device);
00086   \textcolor{keywordflow}{if} (\hyperlink{a00214_gaf72d83e273803226ce772973e37b85de}{hwloc\_linux\_read\_path\_as\_cpumask}(path, \textcolor{keyword}{set}) < 0
00087       || \hyperlink{a00205_ga5b64be28f5a7176ed8ad0d6a90bdf108}{hwloc\_bitmap\_iszero}(\textcolor{keyword}{set}))
00088     \hyperlink{a00205_ga72a29824798b48784b8217471ec8f14c}{hwloc\_bitmap\_copy}(\textcolor{keyword}{set}, \hyperlink{a00202_gaee30e03391c1ed7dfd617fb5c7bbb033}{hwloc\_topology\_get\_complete\_cpuset}
      (topology));
00089 \textcolor{preprocessor}{#else}
00090   \textcolor{comment}{/* Non-Linux systems simply get a full cpuset */}
00091   \hyperlink{a00205_ga72a29824798b48784b8217471ec8f14c}{hwloc\_bitmap\_copy}(\textcolor{keyword}{set}, \hyperlink{a00202_gaee30e03391c1ed7dfd617fb5c7bbb033}{hwloc\_topology\_get\_complete\_cpuset}
      (topology));
00092 \textcolor{preprocessor}{#endif}
00093   \textcolor{keywordflow}{return} 0;
00094 \}
00095 
00110 \textcolor{keyword}{static} \_\_hwloc\_inline \hyperlink{a00238}{hwloc\_obj\_t}
\Hypertarget{a00161_source_l00111}\hyperlink{a00222_ga507d0acdd5e9ac374a8d120d59604c80}{00111} \hyperlink{a00222_ga507d0acdd5e9ac374a8d120d59604c80}{hwloc\_rsmi\_get\_device\_osdev\_by\_index}(
      \hyperlink{a00186_ga9d1e76ee15a7dee158b786c30b6a6e38}{hwloc\_topology\_t} topology, uint32\_t dv\_ind)
00112 \{
00113   \hyperlink{a00238}{hwloc\_obj\_t} osdev = NULL;
00114   \textcolor{keywordflow}{while} ((osdev = \hyperlink{a00204_ga8b4584c8949e2c5f1c97ba7fe92b8145}{hwloc\_get\_next\_osdev}(topology, osdev)) != NULL) \{
00115     \textcolor{keywordflow}{if} (\hyperlink{a00184_gga64f5d539df299c97ae80ce53fc4b56c0aa3a09798ef2836abb236dc3a645ffc90}{HWLOC\_OBJ\_OSDEV\_GPU} == osdev->\hyperlink{a00238_accd40e29f71f19e88db62ea3df02adc8}{attr}->\hyperlink{a00242_a22904c25fe44b323bab5c9bc52660fca}{osdev}.
      \hyperlink{a00282_a31e019e27e54ac6138d04be639bb96f9}{type}
00116       && osdev->\hyperlink{a00238_abb709ec38f2970677e4e57d1d30be96d}{name}
00117       && !strncmp(\textcolor{stringliteral}{"rsmi"}, osdev->\hyperlink{a00238_abb709ec38f2970677e4e57d1d30be96d}{name}, 4)
00118       && atoi(osdev->\hyperlink{a00238_abb709ec38f2970677e4e57d1d30be96d}{name} + 4) == (\textcolor{keywordtype}{int}) dv\_ind)
00119       \textcolor{keywordflow}{return} osdev;
00120   \}
00121   \textcolor{keywordflow}{return} NULL;
00122 \}
00123 
00138 \textcolor{keyword}{static} \_\_hwloc\_inline \hyperlink{a00238}{hwloc\_obj\_t}
\Hypertarget{a00161_source_l00139}\hyperlink{a00222_gaba05bf9710655bb5b1439bee654340ba}{00139} \hyperlink{a00222_gaba05bf9710655bb5b1439bee654340ba}{hwloc\_rsmi\_get\_device\_osdev}(\hyperlink{a00186_ga9d1e76ee15a7dee158b786c30b6a6e38}{hwloc\_topology\_t} topology, uint32\_t 
      dv\_ind)
00140 \{
00141   \hyperlink{a00238}{hwloc\_obj\_t} osdev;
00142   rsmi\_status\_t ret;
00143   uint64\_t bdfid = 0;
00144   \textcolor{keywordtype}{unsigned} domain, device, bus, func;
00145   uint64\_t id;
00146   \textcolor{keywordtype}{char} uuid[64];
00147 
00148   \textcolor{keywordflow}{if} (!\hyperlink{a00193_ga68ffdcfd9175cdf40709801092f18017}{hwloc\_topology\_is\_thissystem}(topology)) \{
00149     errno = EINVAL;
00150     \textcolor{keywordflow}{return} NULL;
00151   \}
00152 
00153   ret = rsmi\_dev\_pci\_id\_get(dv\_ind, &bdfid);
00154   \textcolor{keywordflow}{if} (RSMI\_STATUS\_SUCCESS != ret) \{
00155     errno = EINVAL;
00156     \textcolor{keywordflow}{return} NULL;
00157   \}
00158   domain = (bdfid>>32) & 0xffffffff;
00159   bus = ((bdfid & 0xffff)>>8) & 0xff;
00160   device = ((bdfid & 0xff)>>3) & 0x1f;
00161   func = bdfid & 0x7;
00162 
00163   ret = rsmi\_dev\_unique\_id\_get(dv\_ind, &\textcolor{keywordtype}{id});
00164   \textcolor{keywordflow}{if} (RSMI\_STATUS\_SUCCESS != ret)
00165     uuid[0] = \textcolor{charliteral}{'\(\backslash\)0'};
00166   \textcolor{keywordflow}{else}
00167     sprintf(uuid, \textcolor{stringliteral}{"%lx"}, \textcolor{keywordtype}{id});
00168 
00169   osdev = NULL;
00170   \textcolor{keywordflow}{while} ((osdev = \hyperlink{a00204_ga8b4584c8949e2c5f1c97ba7fe92b8145}{hwloc\_get\_next\_osdev}(topology, osdev)) != NULL) \{
00171     \hyperlink{a00238}{hwloc\_obj\_t} pcidev = osdev->\hyperlink{a00238_adc494f6aed939992be1c55cca5822900}{parent};
00172     \textcolor{keyword}{const} \textcolor{keywordtype}{char} *info;
00173 
00174     \textcolor{keywordflow}{if} (strncmp(osdev->\hyperlink{a00238_abb709ec38f2970677e4e57d1d30be96d}{name}, \textcolor{stringliteral}{"rsmi"}, 4))
00175       \textcolor{keywordflow}{continue};
00176 
00177     \textcolor{keywordflow}{if} (pcidev
00178       && pcidev->\hyperlink{a00238_acc4f0803f244867e68fe0036800be5de}{type} == \hyperlink{a00184_ggacd37bb612667dc437d66bfb175a8dc55a5d8117a54df1fbd3606ab19e42cb0ea9}{HWLOC\_OBJ\_PCI\_DEVICE}
00179       && pcidev->\hyperlink{a00238_accd40e29f71f19e88db62ea3df02adc8}{attr}->\hyperlink{a00242_a4203d713ce0f5beaa6ee0e9bdac70828}{pcidev}.\hyperlink{a00262_a8fba44988deb98613c1505a4019a34dc}{domain} == domain
00180       && pcidev->\hyperlink{a00238_accd40e29f71f19e88db62ea3df02adc8}{attr}->\hyperlink{a00242_a4203d713ce0f5beaa6ee0e9bdac70828}{pcidev}.\hyperlink{a00262_aae99e035e8d1387d7b8768aaa8eceb0a}{bus} == bus
00181       && pcidev->\hyperlink{a00238_accd40e29f71f19e88db62ea3df02adc8}{attr}->\hyperlink{a00242_a4203d713ce0f5beaa6ee0e9bdac70828}{pcidev}.\hyperlink{a00262_a3d70c84a12f7e93d14c8d47bf4fd9dc5}{dev} == device
00182       && pcidev->\hyperlink{a00238_accd40e29f71f19e88db62ea3df02adc8}{attr}->\hyperlink{a00242_a4203d713ce0f5beaa6ee0e9bdac70828}{pcidev}.\hyperlink{a00262_a695f32df53f4ef728670bfcf31b74e0f}{func} == func)
00183       \textcolor{keywordflow}{return} osdev;
00184 
00185     info = \hyperlink{a00189_gab358661a92bb27d8542b255cc9f6f25e}{hwloc\_obj\_get\_info\_by\_name}(osdev, \textcolor{stringliteral}{"AMDUUID"});
00186     \textcolor{keywordflow}{if} (info && !strcmp(info, uuid))
00187       \textcolor{keywordflow}{return} osdev;
00188   \}
00189 
00190   \textcolor{keywordflow}{return} NULL;
00191 \}
00192 
00196 \textcolor{preprocessor}{#ifdef \_\_cplusplus}
00197 \} \textcolor{comment}{/* extern "C" */}
00198 \textcolor{preprocessor}{#endif}
00199 
00200 
00201 \textcolor{preprocessor}{#endif }\textcolor{comment}{/* HWLOC\_RSMI\_H */}\textcolor{preprocessor}{}
\end{DoxyCode}
