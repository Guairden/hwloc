\hypertarget{a00226}{}\section{Sharing topologies between processes}
\label{a00226}\index{Sharing topologies between processes@{Sharing topologies between processes}}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
int \hyperlink{a00226_ga772ab52750cdd0eec85128df24888001}{hwloc\+\_\+shmem\+\_\+topology\+\_\+get\+\_\+length} (\hyperlink{a00186_ga9d1e76ee15a7dee158b786c30b6a6e38}{hwloc\+\_\+topology\+\_\+t} topology, size\+\_\+t $\ast$lengthp, unsigned long flags)
\item 
int \hyperlink{a00226_ga61b20e346fc76f76420e3a88cc80a671}{hwloc\+\_\+shmem\+\_\+topology\+\_\+write} (\hyperlink{a00186_ga9d1e76ee15a7dee158b786c30b6a6e38}{hwloc\+\_\+topology\+\_\+t} topology, int fd, hwloc\+\_\+uint64\+\_\+t fileoffset, void $\ast$mmap\+\_\+address, size\+\_\+t length, unsigned long flags)
\item 
int \hyperlink{a00226_ga21545bd0f09d9b554c8e60a630e0e629}{hwloc\+\_\+shmem\+\_\+topology\+\_\+adopt} (\hyperlink{a00186_ga9d1e76ee15a7dee158b786c30b6a6e38}{hwloc\+\_\+topology\+\_\+t} $\ast$topologyp, int fd, hwloc\+\_\+uint64\+\_\+t fileoffset, void $\ast$mmap\+\_\+address, size\+\_\+t length, unsigned long flags)
\end{DoxyCompactItemize}


\subsection{Detailed Description}
These functions are used to share a topology between processes by duplicating it into a file-\/backed shared-\/memory buffer.

The master process must first get the required shared-\/memory size for storing this topology with \hyperlink{a00226_ga772ab52750cdd0eec85128df24888001}{hwloc\+\_\+shmem\+\_\+topology\+\_\+get\+\_\+length()}.

Then it must find a virtual memory area of that size that is available in all processes (identical virtual addresses in all processes). On Linux, this can be done by comparing holes found in /proc/$<$pid$>$/maps for each process.

Once found, it must open a destination file for storing the buffer, and pass it to \hyperlink{a00226_ga61b20e346fc76f76420e3a88cc80a671}{hwloc\+\_\+shmem\+\_\+topology\+\_\+write()} together with virtual memory address and length obtained above.

Other processes may then adopt this shared topology by opening the same file and passing it to \hyperlink{a00226_ga21545bd0f09d9b554c8e60a630e0e629}{hwloc\+\_\+shmem\+\_\+topology\+\_\+adopt()} with the exact same virtual memory address and length. 

\subsection{Function Documentation}
\mbox{\Hypertarget{a00226_ga21545bd0f09d9b554c8e60a630e0e629}\label{a00226_ga21545bd0f09d9b554c8e60a630e0e629}} 
\index{Sharing topologies between processes@{Sharing topologies between processes}!hwloc\+\_\+shmem\+\_\+topology\+\_\+adopt@{hwloc\+\_\+shmem\+\_\+topology\+\_\+adopt}}
\index{hwloc\+\_\+shmem\+\_\+topology\+\_\+adopt@{hwloc\+\_\+shmem\+\_\+topology\+\_\+adopt}!Sharing topologies between processes@{Sharing topologies between processes}}
\subsubsection{\texorpdfstring{hwloc\+\_\+shmem\+\_\+topology\+\_\+adopt()}{hwloc\_shmem\_topology\_adopt()}}
{\footnotesize\ttfamily int hwloc\+\_\+shmem\+\_\+topology\+\_\+adopt (\begin{DoxyParamCaption}\item[{\hyperlink{a00186_ga9d1e76ee15a7dee158b786c30b6a6e38}{hwloc\+\_\+topology\+\_\+t} $\ast$}]{topologyp,  }\item[{int}]{fd,  }\item[{hwloc\+\_\+uint64\+\_\+t}]{fileoffset,  }\item[{void $\ast$}]{mmap\+\_\+address,  }\item[{size\+\_\+t}]{length,  }\item[{unsigned long}]{flags }\end{DoxyParamCaption})}



Adopt a shared memory topology stored in a file. 

Map a file in virtual memory and adopt the topology that was previously stored there with \hyperlink{a00226_ga61b20e346fc76f76420e3a88cc80a671}{hwloc\+\_\+shmem\+\_\+topology\+\_\+write()}.

The returned adopted topology in {\ttfamily topologyp} can be used just like any topology. And it must be destroyed with \hyperlink{a00186_ga9f34a640b6fd28d23699d4d084667b15}{hwloc\+\_\+topology\+\_\+destroy()} as usual.

However the topology is read-\/only. For instance, it cannot be modified with \hyperlink{a00194_ga6db81ed13ac0a9d70cc80372ab537815}{hwloc\+\_\+topology\+\_\+restrict()} and object userdata pointers cannot be changed.

The segment of the file pointed by descriptor {\ttfamily fd}, starting at offset {\ttfamily fileoffset}, and of length {\ttfamily length} (in bytes), will be mapped at virtual address {\ttfamily mmap\+\_\+address}.

The file pointed by descriptor {\ttfamily fd}, the offset {\ttfamily fileoffset}, the requested mapping virtual address {\ttfamily mmap\+\_\+address} and the length {\ttfamily length} must be identical to what was given to \hyperlink{a00226_ga61b20e346fc76f76420e3a88cc80a671}{hwloc\+\_\+shmem\+\_\+topology\+\_\+write()} earlier.

\begin{DoxyNote}{Note}
Flags {\ttfamily flags} are currently unused, must be 0.

The object userdata pointer should not be used unless the process that created the shared topology also placed userdata-\/pointed buffers in shared memory.

This function takes care of calling \hyperlink{a00186_ga0647ae66458fe68172eb5a320042f870}{hwloc\+\_\+topology\+\_\+abi\+\_\+check()}.
\end{DoxyNote}
\begin{DoxyReturn}{Returns}
-\/1 with errno set to E\+B\+U\+SY if the virtual memory mapping defined by {\ttfamily mmap\+\_\+address} and {\ttfamily length} isn\textquotesingle{}t available in the process.

-\/1 with errno set to E\+I\+N\+V\+AL if {\ttfamily fileoffset}, {\ttfamily mmap\+\_\+address} or {\ttfamily length} aren\textquotesingle{}t page-\/aligned, or do not match what was given to \hyperlink{a00226_ga61b20e346fc76f76420e3a88cc80a671}{hwloc\+\_\+shmem\+\_\+topology\+\_\+write()} earlier.

-\/1 with errno set to E\+I\+N\+V\+AL if the layout of the topology structure is different between the writer process and the adopter process. 
\end{DoxyReturn}
\mbox{\Hypertarget{a00226_ga772ab52750cdd0eec85128df24888001}\label{a00226_ga772ab52750cdd0eec85128df24888001}} 
\index{Sharing topologies between processes@{Sharing topologies between processes}!hwloc\+\_\+shmem\+\_\+topology\+\_\+get\+\_\+length@{hwloc\+\_\+shmem\+\_\+topology\+\_\+get\+\_\+length}}
\index{hwloc\+\_\+shmem\+\_\+topology\+\_\+get\+\_\+length@{hwloc\+\_\+shmem\+\_\+topology\+\_\+get\+\_\+length}!Sharing topologies between processes@{Sharing topologies between processes}}
\subsubsection{\texorpdfstring{hwloc\+\_\+shmem\+\_\+topology\+\_\+get\+\_\+length()}{hwloc\_shmem\_topology\_get\_length()}}
{\footnotesize\ttfamily int hwloc\+\_\+shmem\+\_\+topology\+\_\+get\+\_\+length (\begin{DoxyParamCaption}\item[{\hyperlink{a00186_ga9d1e76ee15a7dee158b786c30b6a6e38}{hwloc\+\_\+topology\+\_\+t}}]{topology,  }\item[{size\+\_\+t $\ast$}]{lengthp,  }\item[{unsigned long}]{flags }\end{DoxyParamCaption})}



Get the required shared memory length for storing a topology. 

This length (in bytes) must be used in \hyperlink{a00226_ga61b20e346fc76f76420e3a88cc80a671}{hwloc\+\_\+shmem\+\_\+topology\+\_\+write()} and \hyperlink{a00226_ga21545bd0f09d9b554c8e60a630e0e629}{hwloc\+\_\+shmem\+\_\+topology\+\_\+adopt()} later.

\begin{DoxyNote}{Note}
Flags {\ttfamily flags} are currently unused, must be 0. 
\end{DoxyNote}
\mbox{\Hypertarget{a00226_ga61b20e346fc76f76420e3a88cc80a671}\label{a00226_ga61b20e346fc76f76420e3a88cc80a671}} 
\index{Sharing topologies between processes@{Sharing topologies between processes}!hwloc\+\_\+shmem\+\_\+topology\+\_\+write@{hwloc\+\_\+shmem\+\_\+topology\+\_\+write}}
\index{hwloc\+\_\+shmem\+\_\+topology\+\_\+write@{hwloc\+\_\+shmem\+\_\+topology\+\_\+write}!Sharing topologies between processes@{Sharing topologies between processes}}
\subsubsection{\texorpdfstring{hwloc\+\_\+shmem\+\_\+topology\+\_\+write()}{hwloc\_shmem\_topology\_write()}}
{\footnotesize\ttfamily int hwloc\+\_\+shmem\+\_\+topology\+\_\+write (\begin{DoxyParamCaption}\item[{\hyperlink{a00186_ga9d1e76ee15a7dee158b786c30b6a6e38}{hwloc\+\_\+topology\+\_\+t}}]{topology,  }\item[{int}]{fd,  }\item[{hwloc\+\_\+uint64\+\_\+t}]{fileoffset,  }\item[{void $\ast$}]{mmap\+\_\+address,  }\item[{size\+\_\+t}]{length,  }\item[{unsigned long}]{flags }\end{DoxyParamCaption})}



Duplicate a topology to a shared memory file. 

Temporarily map a file in virtual memory and duplicate the topology {\ttfamily topology} by allocating duplicates in there.

The segment of the file pointed by descriptor {\ttfamily fd}, starting at offset {\ttfamily fileoffset}, and of length {\ttfamily length} (in bytes), will be temporarily mapped at virtual address {\ttfamily mmap\+\_\+address} during the duplication.

The mapping length {\ttfamily length} must have been previously obtained with \hyperlink{a00226_ga772ab52750cdd0eec85128df24888001}{hwloc\+\_\+shmem\+\_\+topology\+\_\+get\+\_\+length()} and the topology must not have been modified in the meantime.

\begin{DoxyNote}{Note}
Flags {\ttfamily flags} are currently unused, must be 0.

The object userdata pointer is duplicated but the pointed buffer is not. However the caller may also allocate it manually in shared memory to share it as well.
\end{DoxyNote}
\begin{DoxyReturn}{Returns}
-\/1 with errno set to E\+B\+U\+SY if the virtual memory mapping defined by {\ttfamily mmap\+\_\+address} and {\ttfamily length} isn\textquotesingle{}t available in the process. 

-\/1 with errno set to E\+I\+N\+V\+AL if {\ttfamily fileoffset}, {\ttfamily mmap\+\_\+address} or {\ttfamily length} aren\textquotesingle{}t page-\/aligned. 
\end{DoxyReturn}
